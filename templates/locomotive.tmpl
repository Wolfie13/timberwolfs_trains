{{ $zoom := parseint .globals.zoom }}

{{ altsprites .id "template_rail" $zoom }}

// Graphics - animated or not
{{ if .animated -}}
{{ $ani1 := concat .id "_anim_1" }}{{ altsprites8 $ani1 "template_rail" $zoom }}
{{ $ani2 := concat .id "_anim_2" }}{{ altsprites8 $ani2 "template_rail" $zoom }}
{{ $ani3 := concat .id "_anim_3" }}{{ altsprites8 $ani3 "template_rail" $zoom }}
{{ $ani4 := concat .id "_anim_4" }}{{ altsprites8 $ani4 "template_rail" $zoom }}
{{- end }}


// Articulation
switch(FEAT_TRAINS, SELF, switch_{{.id}}_articulation, extra_callback_info1) {
    0 .. {{if .tender}}5{{else}}2{{end}}: return vehicle_{{.id}};
    return CB_RESULT_NO_MORE_ARTICULATED_PARTS;
}

switch (FEAT_TRAINS, SELF, switch_{{.id}}_length, position_in_consist % {{if .tender}}6{{else}}3{{end}}) 
{
    {{range $index, $element := slice .articulated_lengths -}}
    {{$index }}: return {{ $element }};
    {{end}}    
}


{{ if .animated -}}
switch (FEAT_TRAINS, SELF, switch_{{.id}}_animation, motion_counter % 4) 
{
    0: return spriteset_{{.id}}_anim_1;
    1: return spriteset_{{.id}}_anim_2;
    2: return spriteset_{{.id}}_anim_3;
    3: return spriteset_{{.id}}_anim_4;
}

switch(FEAT_TRAINS, SELF, switch_{{.id}}_animation_overlay, [
    STORE_TEMP((getbits(extra_callback_info1, 8, 8) < 1 ? CB_FLAG_MORE_SPRITES : 0) | PALETTE_USE_DEFAULT, 0x100),
    getbits(extra_callback_info1, 8, 8)
    ]) {
    0: spriteset_{{.id}};
    1: switch_{{.id}}_animation;

    // This should never be executed
    return spriteset_invisible;
}

switch (FEAT_TRAINS, SELF, switch_{{.id}}_graphics, position_in_consist % {{if .tender}}6{{else}}3{{end}}) 
{
    1: switch_{{.id}}_animation_overlay;
    {{- if .tender }}
    4: return spriteset_{{.tender}};
    {{- end}}
    return spriteset_invisible;
}

{{else -}}
switch (FEAT_TRAINS, SELF, switch_{{.id}}_graphics, position_in_consist % {{if .tender}}6{{else}}3{{end}}) 
{
    1: return spriteset_{{.id}};
    {{- if .tender }}
    4: return spriteset_{{.tender}};
    {{- end}}
    return spriteset_invisible;
}
{{- end}}



// Visual effect
switch (FEAT_TRAINS, SELF, switch_{{.id}}_visual_effect, position_in_consist % {{if .tender}}6{{else}}3{{end}}) 
{ 
    {{ if eq .type "steam" -}}
    0: return visual_effect(VISUAL_EFFECT_STEAM, -1);
    {{ else if eq .type "electric" -}}
    1: return visual_effect(VISUAL_EFFECT_ELECTRIC, 0);
    {{else -}}
    1: return visual_effect(VISUAL_EFFECT_DIESEL, 0);
    {{- end}}
    return VISUAL_EFFECT_DISABLE;
}

item(FEAT_TRAINS, vehicle_{{.id}}) {
    property {
        name:                         {{.name_string}};
        climates_available:           bitmask(CLIMATE_TEMPERATE, CLIMATE_ARCTIC, CLIMATE_TROPICAL);
        introduction_date:            date({{.year}}, 1, 1);
        model_life:                   VEHICLE_NEVER_EXPIRES;
        vehicle_life:                 30;

        {{ if eq .type "steam" -}}
        engine_class:                 ENGINE_CLASS_STEAM;
        running_cost_base:            RUNNING_COST_STEAM;
        {{ else if eq .type "electric" -}}
        engine_class:                 ENGINE_CLASS_ELECTRIC;
        running_cost_base:            RUNNING_COST_ELECTRIC;
        {{else -}}
        engine_class:                 ENGINE_CLASS_DIESEL;
        running_cost_base:            RUNNING_COST_DIESEL;
        {{- end}}

        tractive_effort_coefficient:  {{.te_coeff}};

        power:                        {{.power}} hp;
        speed:                        {{.speed}} mph;
        reliability_decay:            20;
        {{if .loading_speed}}loading_speed:                {{.loading_speed}};{{end}}
        cost_factor:                  {{.cost}};
        running_cost_factor:          {{.running_cost}};
        sprite_id:                    SPRITE_ID_NEW_TRAIN;
        misc_flags:                   bitmask(TRAIN_FLAG_2CC {{if .animated}}, TRAIN_FLAG_SPRITE_STACK{{end}});
        refit_cost:                   0;
        track_type:                   {{.railtype}};

        {{if .capacity}}cargo_capacity:               {{.capacity}};{{end}}
        weight:                       {{.weight}} ton;
        
    }

    graphics {
        default:  switch_{{.id}}_graphics;
        articulated_part: switch_{{.id}}_articulation;
        length: switch_{{.id}}_length;
        visual_effect_and_powered: switch_{{.id}}_visual_effect;
    }
}
